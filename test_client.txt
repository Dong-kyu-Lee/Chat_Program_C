// 탭 오버레이 토글 함수
void on_tab_button_clicked(GtkButton* button, gpointer user_data) {
    GtkWidget* tab_overlay = GTK_WIDGET(user_data);
    gboolean visible = gtk_widget_get_visible(tab_overlay);
    if (visible)
        gtk_widget_hide(tab_overlay);
    else
        gtk_widget_show(tab_overlay);
}

// Exit 버튼 콜백
void on_exit_clicked(GtkButton* button, gpointer user_data) {
    GtkWidget* window = GTK_WIDGET(user_data);
    gtk_widget_destroy(window);
}

gboolean create_room_idle(gpointer data)
{
	const char* room_name = (const char*)data;
	printf("[DEBUG] create_room_idle called with room_name: %s\n", room_name);

    GtkWidget* window = gtk_window_new(GTK_WINDOW_TOPLEVEL);
    gtk_window_set_title(GTK_WINDOW(window), room_name);
    gtk_window_set_default_size(GTK_WINDOW(window), 400, 600);

    GtkWidget* overlay = gtk_overlay_new();
    gtk_container_add(GTK_CONTAINER(window), overlay);

    // 메인 VBox
    GtkWidget* vbox = gtk_box_new(GTK_ORIENTATION_VERTICAL, 5);
    gtk_overlay_add_overlay(GTK_OVERLAY(overlay), vbox);

    // 상단 바
    GtkWidget* topbar = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);
    gtk_box_pack_start(GTK_BOX(vbox), topbar, FALSE, FALSE, 0);

    GtkWidget* back_btn = gtk_button_new_with_label("<");
    gtk_box_pack_start(GTK_BOX(topbar), back_btn, FALSE, FALSE, 0);

    GtkWidget* tab_btn = gtk_button_new();
    GtkWidget* tab_icon = gtk_image_new_from_icon_name("open-menu-symbolic", GTK_ICON_SIZE_BUTTON);
    gtk_button_set_image(GTK_BUTTON(tab_btn), tab_icon);
    gtk_box_pack_end(GTK_BOX(topbar), tab_btn, FALSE, FALSE, 0);

    // 채팅 메시지 영역
    GtkWidget* scrolled = gtk_scrolled_window_new(NULL, NULL);
    gtk_widget_set_vexpand(scrolled, TRUE);
    gtk_box_pack_start(GTK_BOX(vbox), scrolled, TRUE, TRUE, 0);

    GtkWidget* listbox = gtk_list_box_new();
    gtk_container_add(GTK_CONTAINER(scrolled), listbox);

    // 하단 입력창 + 버튼
    GtkWidget* hbox = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5);
    gtk_box_pack_start(GTK_BOX(vbox), hbox, FALSE, FALSE, 0);

    GtkWidget* entry = gtk_entry_new();
    gtk_box_pack_start(GTK_BOX(hbox), entry, TRUE, TRUE, 0);

    GtkWidget* send_btn = gtk_button_new_with_label("Send");
    gtk_box_pack_start(GTK_BOX(hbox), send_btn, FALSE, FALSE, 0);

    // --- 탭 오버레이 화면 ---
    GtkWidget* tab_overlay = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);
    gtk_widget_set_size_request(tab_overlay, 400, 400);
    gtk_overlay_add_overlay(GTK_OVERLAY(overlay), tab_overlay);
    gtk_widget_set_halign(tab_overlay, GTK_ALIGN_FILL);
    gtk_widget_set_valign(tab_overlay, GTK_ALIGN_FILL);
    gtk_widget_hide(tab_overlay);

    // 좌측: 사용자 목록
    GtkWidget* user_list = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_widget_set_size_request(user_list, 120, -1);
    gtk_box_pack_start(GTK_BOX(tab_overlay), user_list, FALSE, FALSE, 0);

    GtkWidget* user1 = gtk_label_new("Lilly");
    GtkWidget* user2 = gtk_label_new("Marco");
    GtkWidget* user3 = gtk_label_new("Steve");
    gtk_box_pack_start(GTK_BOX(user_list), user1, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(user_list), user2, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(user_list), user3, FALSE, FALSE, 0);

    // 우측: 메뉴 버튼
    GtkWidget* menu_box = gtk_box_new(GTK_ORIENTATION_VERTICAL, 20);
    gtk_box_pack_start(GTK_BOX(tab_overlay), menu_box, TRUE, TRUE, 0);

    GtkWidget* invite_btn = gtk_button_new_with_label("Invite Friend");
    GtkWidget* vote_btn = gtk_button_new_with_label("Vote");
    GtkWidget* chess_btn = gtk_button_new_with_label("Chess Game");
    GtkWidget* exit_btn = gtk_button_new_with_label("Exit");
    gtk_box_pack_start(GTK_BOX(menu_box), invite_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(menu_box), vote_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(menu_box), chess_btn, FALSE, FALSE, 0);
    gtk_box_pack_start(GTK_BOX(menu_box), exit_btn, FALSE, FALSE, 0);

    // 콜백 연결
    g_signal_connect(tab_btn, "clicked", G_CALLBACK(on_tab_button_clicked), tab_overlay);
    g_signal_connect(exit_btn, "clicked", G_CALLBACK(on_exit_clicked), window);

    gtk_widget_show_all(window);
    gtk_widget_hide(tab_overlay); // 시작 시 탭 화면 숨김
}